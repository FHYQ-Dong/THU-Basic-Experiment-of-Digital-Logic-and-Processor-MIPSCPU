\documentclass[utf8,twocolumn]{article}
\usepackage{ctex}
\usepackage{amsmath}
\usepackage{circuitikz}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{pdfpages}
\usepackage{booktabs}
\usepackage{subfigure}
\usepackage{float}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathrsfs}
\usepackage{multirow}
\usepackage{inputenc}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage[dvipsnames]{xcolor}
\usepackage{fontspec}

\newfontfamily\codefont[
    Path = fonts/,
    Extension = .ttf,
    UprightFont = *-Regular,
    BoldFont = *-Bold,
    ItalicFont = *-Italic,
    BoldItalicFont = *-BoldItalic,
    Scale = MatchLowercase,
]{SarasaMonoSC}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=black,      
    urlcolor=black,
    citecolor=black,
}
\lstdefinestyle{code}{ 
    basicstyle   = \codefont,
    breaklines   = true,
    breakindent  = 0pt,
    tabsize      = 4,
    keywordstyle = \bfseries\color{NavyBlue},
    emphstyle    = \bfseries\color{Rhodamine},
    commentstyle = \itshape\color{PineGreen},
    stringstyle  = \bfseries\color{Orange!90!black},
    columns      = fixed,
    numbers      = left,
    numbersep    = 2em,
    numberstyle  = \footnotesize,
    frame        = single,
    framesep     = 1em,
    keepspaces   = true,
    showspaces   = false,
    showstringspaces = false,
}
\lstset{style=code}
\lstdefinelanguage[mips]{Assembler}{%
    alsoletter={.\$},
    morestring=[b]",
    morestring=[b]',
    morecomment=[l]\#,
    morekeywords={[1]abs,abs.d,abs.s,add,add.d,add.s,addi,addiu,addu,%
        and,andi,b,bc1f,bc1t,beq,beqz,bge,bgeu,bgez,bgezal,bgt,bgtu,%
        bgtz,ble,bleu,blez,blt,bltu,bltz,bltzal,bne,bnez,break,c.eq.d,%
        c.eq.s,c.le.d,c.le.s,c.lt.d,c.lt.s,ceil.w.d,ceil.w.s,clo,clz,%
        cvt.d.s,cvt.d.w,cvt.s.d,cvt.s.w,cvt.w.d,cvt.w.s,div,div.d,div.s,%
        divu,eret,floor.w.d,floor.w.s,j,jal,jalr,jr,l.d,l.s,la,lb,lbu,%
        ld,ldc1,lh,lhu,li,ll,lui,lw,lwc1,lwl,lwr,madd,maddu,mfc0,mfc1,%
        mfc1.d,mfhi,mflo,mov.d,mov.s,move,movf,movf.d,movf.s,movn,movn.d,%
        movn.s,movt,movt.d,movt.s,movz,movz.d,movz.s,msub,msubu,mtc0,mtc1,%
        mtc1.d,mthi,mtlo,mul,mul.d,mul.s,mulo,mulou,mult,multu,mulu,neg,%
        neg.d,neg.s,negu,nop,nor,not,or,ori,rem,remu,rol,ror,round.w.d,%
        round.w.s,s.d,s.s,sb,sc,sd,sdc1,seq,sge,sgeu,sgt,sgtu,sh,sle,%
        sleu,sll,sllv,slt,slti,sltiu,sltu,sne,sqrt.d,sqrt.s,sra,srav,srl,%
        srlv,sub,sub.d,sub.s,subi,subiu,subu,sw,swc1,swl,swr,syscall,teq,%
        teqi,tge,tgei,tgeiu,tgeu,tlt,tlti,tltiu,tltu,tne,tnei,trunc.w.d,%
        trunc.w.s,ulh,ulhu,ulw,ush,usw,xor,xori},
    morekeywords={[2].align,.ascii,.asciiz,.byte,.data,.double,.extern,%
        .float,.globl,.half,.kdata,.ktext,.set,.space,.text,.word},
    morekeywords={[3]\$0,\$1,\$2,\$3,\$4,\$5,\$6,\$7,\$8,\$9,\$10,\$11,%
        \$12,\$13,\$14,\$15,\$16,\$17,\$18,\$19,\$20,\$21,\$22,\$23,\$24,%
        \$25,\$26,\$27,\$28,\$29,\$30,\$31,%
        \$zero,\$at,\$v0,\$v1,\$a0,\$a1,\$a2,\$a3,\$t0,\$t1,\$t2,\$t3,\$t4,
        \$t5,\$t6,\$t7,\$s0,\$s1,\$s2,\$s3,\$s4,\$s5,\$s6,\$s7,\$t8,\$t9,%
        \$k0,\$k1,\$gp,\$sp,\$fp,\$ra},
}[strings,comments,keywords]
\geometry{a4paper, scale=0.8}
\pagestyle{fancy}
\fancyhf{}
\lhead{流水线MIPS处理器的设计报告}
\rhead{无37~董皓彧~2023010659}
\cfoot{---~~\thepage~~---}
\setlength{\columnsep}{20pt}


\title{流水线MIPS处理器的设计报告}
\author{无37~董皓彧~2023010659}
\date{\zhtoday}

\begin{document}

\maketitle
\thispagestyle{fancy}


\section{仿真测试}

\subsection{CPU性能}

\subsubsection{CPI}
将完整的稀疏矩阵乘法汇编程序中的稀疏矩阵乘法部分代码截取出来（Listing \ref{code:sim-tb-sparse-matmul-mars-asm}），通过Mars仿真器统计指令数为653条（图 \ref{fig:instruction-count}）。需要注意的是Mars仿真器默认数据存储地址与Verilog实现的数据存储器不同，需要在 \lstinline|Memory Configuration| 中选择 \lstinline|Compact, Data at Address 0| 选项。
\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{images/Instruction-Count.png}
    \vspace{-2em}
    \caption{Mars仿真器统计指令数}
    \vspace{-2em}
    \label{fig:instruction-count}
\end{figure}
同时，使用Mars将该汇编代码的 \lstinline|.text| 部分转换为机器码，进行行为级仿真，从波形文件中读出程序起始于10000ps，结束于7370000ps，时钟周期为10000ps（图 \ref{fig:simulation-time}）。执行这段程序消耗了736个时钟周期，因此CPI为
\begin{equation}
    \text{CPI} = \frac{\text{时钟周期数}}{\text{指令数}} = \frac{736}{653} \approx 1.13
\end{equation}
\begin{figure}[H]
    \centering
    \subfigure[起始时间]{
        \includegraphics[width=\linewidth]{images/Instruction-Timing-Start.png}
    }
    \\
    \subfigure[结束时间]{
        \includegraphics[width=\linewidth]{images/Instruction-Timing-End.png}
    }
    \vspace{-1em}
    \caption{稀疏矩阵乘法算法行为级仿真波形图}
    \label{fig:simulation-time}
\end{figure}


\onecolumn
\appendix
% \input{secs/appA_sources.tex}


\end{document}
