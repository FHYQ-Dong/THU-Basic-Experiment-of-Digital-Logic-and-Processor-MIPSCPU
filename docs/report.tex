\documentclass[utf8,twocolumn]{article}
\usepackage{ctex}
\usepackage{amsmath}
\usepackage{circuitikz}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage{pdfpages}
\usepackage{booktabs}
\usepackage{subfigure}
\usepackage{float}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{mathrsfs}
\usepackage{multirow}
\usepackage{inputenc}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage[dvipsnames]{xcolor}
\usepackage{fontspec}

\newfontfamily\codefont[
    Path = fonts/,
    Extension = .ttf,
    UprightFont = *-Regular,  % JetBrainsMono-Regular
    BoldFont = *-Bold,     % JetBrainsMono-Bold
    ItalicFont = *-Italic,
    BoldItalicFont = *-BoldItalic,
    Scale = MatchLowercase,
]{JetBrainsMonoNL}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=black,      
    urlcolor=black,
    citecolor=black,
}
\lstdefinestyle{code}{ 
    basicstyle   = \codefont\small,
    columns      = fullflexible,
    breaklines   = true,
    breakindent  = 0pt,
    tabsize      = 4,
    keywordstyle = \bfseries\color{NavyBlue},
    emphstyle    = \bfseries\color{Rhodamine},
    commentstyle = \itshape\color{PineGreen},
    stringstyle  = \bfseries\color{Orange!90!black},
    columns      = flexible,
    numbers      = left,
    numbersep    = 2em,
    numberstyle  = \footnotesize,
    frame        = single,
    framesep     = 1em
}
\lstset{style=code}
\lstdefinelanguage[mips]{Assembler}{%
  alsoletter={.\$},
  morestring=[b]",
  morestring=[b]',
  morecomment=[l]\#,
  morekeywords={[1]abs,abs.d,abs.s,add,add.d,add.s,addi,addiu,addu,%
    and,andi,b,bc1f,bc1t,beq,beqz,bge,bgeu,bgez,bgezal,bgt,bgtu,%
    bgtz,ble,bleu,blez,blt,bltu,bltz,bltzal,bne,bnez,break,c.eq.d,%
    c.eq.s,c.le.d,c.le.s,c.lt.d,c.lt.s,ceil.w.d,ceil.w.s,clo,clz,%
    cvt.d.s,cvt.d.w,cvt.s.d,cvt.s.w,cvt.w.d,cvt.w.s,div,div.d,div.s,%
    divu,eret,floor.w.d,floor.w.s,j,jal,jalr,jr,l.d,l.s,la,lb,lbu,%
    ld,ldc1,lh,lhu,li,ll,lui,lw,lwc1,lwl,lwr,madd,maddu,mfc0,mfc1,%
    mfc1.d,mfhi,mflo,mov.d,mov.s,move,movf,movf.d,movf.s,movn,movn.d,%
    movn.s,movt,movt.d,movt.s,movz,movz.d,movz.s,msub,msubu,mtc0,mtc1,%
    mtc1.d,mthi,mtlo,mul,mul.d,mul.s,mulo,mulou,mult,multu,mulu,neg,%
    neg.d,neg.s,negu,nop,nor,not,or,ori,rem,remu,rol,ror,round.w.d,%
    round.w.s,s.d,s.s,sb,sc,sd,sdc1,seq,sge,sgeu,sgt,sgtu,sh,sle,%
    sleu,sll,sllv,slt,slti,sltiu,sltu,sne,sqrt.d,sqrt.s,sra,srav,srl,%
    srlv,sub,sub.d,sub.s,subi,subiu,subu,sw,swc1,swl,swr,syscall,teq,%
    teqi,tge,tgei,tgeiu,tgeu,tlt,tlti,tltiu,tltu,tne,tnei,trunc.w.d,%
    trunc.w.s,ulh,ulhu,ulw,ush,usw,xor,xori},
  morekeywords={[2].align,.ascii,.asciiz,.byte,.data,.double,.extern,%
    .float,.globl,.half,.kdata,.ktext,.set,.space,.text,.word},
  morekeywords={[3]\$0,\$1,\$2,\$3,\$4,\$5,\$6,\$7,\$8,\$9,\$10,\$11,%
    \$12,\$13,\$14,\$15,\$16,\$17,\$18,\$19,\$20,\$21,\$22,\$23,\$24,%
    \$25,\$26,\$27,\$28,\$29,\$30,\$31,%
    \$zero,\$at,\$v0,\$v1,\$a0,\$a1,\$a2,\$a3,\$t0,\$t1,\$t2,\$t3,\$t4,
    \$t5,\$t6,\$t7,\$s0,\$s1,\$s2,\$s3,\$s4,\$s5,\$s6,\$s7,\$t8,\$t9,%
    \$k0,\$k1,\$gp,\$sp,\$fp,\$ra},
}[strings,comments,keywords]
\geometry{a4paper, scale=0.8}
\pagestyle{fancy}
\fancyhf{}
\lhead{流水线MIPS处理器的设计报告}
\rhead{无37~董皓彧~2023010659}
\cfoot{---~~\thepage~~---}
\setlength{\columnsep}{20pt}


\title{流水线MIPS处理器的设计报告}
\author{无37~董皓彧~2023010659}
\date{\zhtoday}

\begin{document}

\maketitle
\thispagestyle{fancy}


\section{仿真测试}
\subsection{CPU性能}
\subsubsection{CPI}
将完整的稀疏矩阵乘法汇编程序中的稀疏矩阵乘法部分代码截取出来（Listling \ref{code:sim-matmul}），通过Mars仿真器统计指令数结果为839条（图 \ref{fig:instruction-count}）。
\begin{figure}
    \centering
    \includegraphics[width=0.5\linewidth]{images/Instruction-Count.png}
    \caption{Mars仿真器统计指令数}
    \label{fig:instruction-count}
\end{figure}


\onecolumn
\appendix
\section{源代码}
源代码的组织方式如下：
\begin{lstlisting}[language={bash}, numbers=none]
    user/
    ├── src/
    │   ├── top.v # 顶层模块
    │   ├── cpu.v
    │   ├── alu.v
    │   ├── control.v
    │   ├── data_memory.v
    │   ├── instruction_memory.v
    │   ├── register_file.v
    │   ├── sign_extend.v
    │   ├── shift_left_2.v
    │   └── hazard_detection.v
    ├── sim/
    │   ├── sparse_matmul_mars.asm
    │   └── sparse_matmul_mars.mars
    └── tb/
        ├── tb_cpu.v
        └── tb_cpu.vcd
\end{lstlisting}
\lstinputlisting[language={Verilog}, caption={user/src/top.v}, label={code:src-top}]{../user/src/top.v}
\lstinputlisting[language={[mips]Assembler}, caption={user/sim/sparse\_matmul\_mars.asm}, label={code:sim-matmul}]{../user/sim/sparse_matmul_mars.asm}

\end{document}
